\section{Countermeasures to known attacks}
\label{sec:defenses}

As demonstrated in the previous section a manufacturer has to guard against a multitude of attacks. For designing effective defensive mechanisms one has to enumerate the likely attack scenarios and methods, type of attacker they will be facing and decide the type and extend of confidentiality they would like to provide\citep{sergei:thesis}\citep{kocher:DPA}.

A common first line of defence that is often encountered in attempts to secure systems, with questionable effectiveness, is security by obscurity and in the case of MCUs can be achieved in a number of different ways. The manufacturers can simply avoid printing their logos or model numbers on parts they produce or print on their products identifiers of more secure or expensive products \footnote{Related legal issues discussed in Sec.~\ref{sec:conclusion}\red{hardware reveng legal issues}} or even try to make their MCUs look like ASICs \footnote{\red{abbreviation?}} in order to scare away potential attackers by making their product appear more secure\citep{sergei:thesis}\citep{hwre}, as this will make information gathering for he chip trickier. A further step in making the MCU harder to analyse is hardware obfuscation by making the interconnects into a maze \citep{hwre} or by making a group of gates commonly placed in well known structures for performing a given task (for example DES circuitry) intentionally more complicated and physically placed in a different locations or additional circuitry is added in order to thwart analysis\citep{anderson:cautionary_note}. Vendors also try to make information on their products hard to find by selling only to selected partners or under non-disclosure agreements\citep{sergei:thesis}.

Security through obscurity has received lots of criticism, and rightfully so, as it will do little to stop experienced or determined attackers. Despite its financial appeal a more effective approach is security in depth, a model in which information is protected by a number of (potentially) different defence mechanisms and in this scenario could be employed at different levels of the chip, from its external potting (or encasing) to its layered architecture. Given the attack categories presented in Sec.~\ref{sec:curr_attacks}, it would be useful to broadly categorize defences in a similar fashion.

Non-invasive attacks are the least sophisticated type of attack but protection against them is a relatively laborious process\citep{anderson:cautionary_note}. A first step to prevent unauthorized access to the firmware is using lock bits and fuses\citep{atmega_manual}\citep{tech:avrfreaks} and some manufacturers (or developers) go as far as physically destroying reading pins or cutting out testing circuitry\citep{sergei:thesis}, while still being able to safely deliver firmware update\citep{tech:aes_bls}. Further protection is introduced by avoiding side-channel leakage by masking all relationships between data input and power consumption, thermal and electromagnetic radiation and timing relationships\citep{kocher:DPA}\cite{sergei:thesis}. Given the software release model and the power of MCUs it's not unreasonable to strive for efficiency, both in terms of consumption and components, and bytecode optimizations performed by compilers and the hardware architecture of the instruction pipeline of an MCU might introduce leakage \citep{kocher:DPA}\citep{sergei:thesis} by how branches are performed, instructions pre-fetched or not take constant time for operations (or execution of different instructions). Even if constant time for cryptographic operations is taken for correct and erroneous keys, or random delays are introduced such that timing relationships are masked, storing intermediate results still poses a problem due to the fact that a 0 and a 1 consume different power when handled (due to the physical nature of CMOS transistors) and hence the power consumed in a given operation is proportional to the amount of 1 bits, a concept known as "Hamming weight" \citep{website:riscure}\citep{kocher:DPA}\footnote{\red{maybe read this about CPA as well https://www.iacr.org/archive/ches2004/31560016/31560016.pdf}}. More approaches to thwarting power analysis include using a lower operating voltage so that power fluctuations are less evident or is introducing noise and delays by means of a random number generator with variable power consumption\citep{kocher:DPA}\citep{hwre}\citep{avr_mega}. Electromagnetic or thermal emission detection can be avoided by packaging that is appropriately shielded\citep{website:ibm_secure}\citep{kocher:DPA}. 

Protection against invasive and semi-invasive attacks is a lot harder because these attacks involve a range of chip modifications (from decapsulation to modification of the die), requiring varied anti-tampering mechanisms. A common technique employed by a number of MCUs is to keep cryptographic or otherwise secret information in an internal battery-backed SRAM \citep{hwre}\citep{sergei:thesis} module connected to a tamper detection circuit, in order to be able to zero-out sensitive information on tamper detection; we will proceed to give a description of tamper detection mechanisms in the order in which decapsulation occurs. Thwarting decapsulation can get very creative as decapsulation techniques depend on the material from which the chip packaging is made of (varied from pure plastic to ceramic or metal) and its physical construction, with techniques ranging from using a sharp object to pull the top off \citep{sergei:thesis} to using acids and other chemicals \citep{hwre}\citep{sergei:thesis} to etch the top layer away and expose the die surface and manufacturers trying to make the decapsulation process as hard as possible. Common techniques involve sealing the die in conductive packaging or making the packaging from conductive and very hard epoxy resin such that packaging removal will result in power supply loss and a response from intrusion detection circuitry from the chip; common responses include erasing sensitive information from the internal SRAM\citep{hwre}, resetting of the device \citep{sergei:thesis} or, for military grade equipment, have reactive chemicals or little charges embedded in the packaging that would respond to stimuli such as other chemicals or small currents (as a result of optical imaging) in a very violent manner and destroy the chip completely. Additional measures include the scattering or photoresistors inside the epoxy which would detect light if the epoxy was removed and hence the tampering attempt\citep{sergei:thesis}\citep{hwre}.

The next level of protection came when radiation attacks became known\citep{sergei:thesis}, where attackers used to override fuses by exposing them to UV light. The defensive response to that was the addition of opaque metal rectangles on top of critical components, or the entire die, in order to shield them from radiation and scattering additional security fuses, which were usually hidden near critical memory areas like the Reset or Interrupt Vector Addresses in order to make harder to locate them and damage other components as well when tampered\citep{sergei:thesis}\citep{hwre}. A further step to protect the top of the device was to place conductive wire mesh layer(s) over the chip area before it is embedded in epoxy , like in the IBM $\mu$ABYSS \citep{website:ibm_secure} and the Atmel ATSHA204\citep{hwre}, in an attempt to detect tampering and erase the keys from SRAM if the power is disrupted. These mechanisms attempt to thwart micro-probing and modification attacks (both memory contents and circuitry modification)  but also prevent visual inspection and fanalysis of the die\citep{hwre}, making the localisation of critical components harder and are commonly found in smart-cards\citep{sergei:thesis} and SIM cards as well\citep{hwre}. Another approach to preventing visual inspection and IR imaging (without de-layering the die) is the doping of semiconductor materials in order to reduce light penetration\citep{sergei:thesis}, as well as chemical or mechanical planarization\footnote{\red{planarization techniques here \url{http://www.stanford.edu/class/ee311/NOTES/Deposition_Planarization.pdf}}} of the layers of the MCU\citep{sergei:thesis}. Physical modification of the chip could be prevented by having both hardware health-check routines and by software self tests comparing the known cipher-output of a magic value stored in the device with the actual output of that device \citep{anderson:tamper_resistance}.

Additional tamper-resistance detection and prevention methods include the addition of environmental sensors for detecting temperature, radiation, operating voltage and clock frequency\citep{sergei:thesis}. Expensive or military grade equipment comes with even more tamper detection features than the above, like tilting sensors (a popular example is the IBM 4758)\citep{website:ibm_secure}, or are designed in a way that removal of a layer should guarantee the destruction of other layers\citep{anderson:cautionary_note}. Although these measures sound complicated, in practice they are not as effective as they pretend to be and only protect against one specific attack (e.g. voltage regulators will not respond to clock glitches) as well as introducing some instability issues\citep{anderson:cautionary_note}. For example optical sensors would fail to detect an attack utilizing a laser as a light source in a dark room\citep{hwre} or one could paint over the sensors with black paint\citep{sergei:thesis}. Tampering and micro-probing is in reality being made harder by the shrinking sizes of the various components due to technological progress, requiring more expensive equipment and specialization, as well as the use of different fabrication techniques, like the application of an ASIC-like glue logic \citep{sergei:thesis}\citep{hwre}.